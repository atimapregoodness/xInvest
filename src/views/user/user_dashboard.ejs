<%- layout('layout/acctBoilerplate', { title: 'Finovex - Dashboard' }) %> <%-
partial("partials/floatingNav") %> <%- partial('partials/sideBar') %>



<div class="dashboard">
  <!-- VERIFICATION MESSAGE -->
  <% if (!user.verified) { %>
  <div class="verification-banner">
    <div class="banner-content">
      <i class="fas fa-exclamation-triangle"></i>
      <div>
        <h3>Account Not Yet Verified!</h3>
        <p>Document verification is required to complete registration</p>
      </div>
      <a href="/verify" class="verify-btn">
        <i class="fas fa-upload"></i> Upload Document
      </a>
    </div>
  </div>
  <% } %>

  <div class="stat-card balance-card glass-card">
    <div class="stat-header">
      <i class="fas fa-wallet"></i>
      <h3>BALANCE</h3>
    </div>
    <div class="stat-value text-white">
      $<span id="balanceAmount"><%= wallet.totalBalance?.toLocaleString() || "0.00" %></span>
    </div>
    <div class="crypto-breakdown text-muted small">
      <div class="crypto-item">
        <i class="fab fa-bitcoin text-warning"></i>
        Bitcoin: <strong id="btc-holding"><%= wallet.BTC.toLocaleString()  || "0.00" %></strong>
      </div>
      <div class="crypto-item">
        <i class="fab fa-ethereum text-primary"></i>
        Ethereum: <strong id="eth-holding"><%= wallet.ETH.toLocaleString()  || "0.00" %></strong>
      </div>
      <div class="crypto-item">
        <i class="fas fa-dollar-sign text-success"></i>
        USDT: <strong id="usdt-holding"><%= wallet.USDT?.toLocaleString() || "0.00" %></strong>
      </div>
    </div>
  </div>

<section class="dashboard-stats">
  <!-- BALANCE CARD -->
  
  <!-- PROFIT RETURN CARD -->
  <div class="stat-card profit-card glass-card">
    <div class="stat-header">
      <i class="fas fa-chart-line"></i>
      <h3>PROFIT RETURN</h3>
    </div>
    <div class="stat-value text-white">
      $<span id="profit-return"><%= wallet.profit?.toFixed(2) || "0.00" %></span>
    </div>
  </div>

  <!-- BONUS CARD -->
  <div class="stat-card bonus-card glass-card">
    <div class="stat-header">
      <i class="fas fa-gift"></i>
      <h3>BONUS</h3>
    </div>
    <div class="stat-value text-white">
      $<span id="bonus-amount"><%= wallet.bonus?.totalBonus?.toFixed(2) || "0.00" %></span>
    </div>
    <div class="crypto-breakdown text-muted small">
      <div class="crypto-item">
        <i class="fab fa-bitcoin text-warning"></i>
        Bitcoin: <strong id="bonus-btc"><%= wallet.bonus?.BTC || 0 %></strong>
      </div>
      <div class="crypto-item">
        <i class="fab fa-ethereum text-primary"></i>
        Ethereum: <strong id="bonus-eth"><%= wallet.bonus?.ETH || 0 %></strong>
      </div>
    </div>
  </div>
</section>

<!-- ===================== INVESTMENT STATS ===================== -->
<section class="investment-stats py-4">
  <div class="stat-row">
    <!-- TOTAL DEPOSIT -->
    <div class="stat-card deposit-card glass-card">
      <div class="stat-header d-flex align-items-center justify-content-between">
        <h3 class="fw-bold text-success"><i class="fas fa-arrow-down me-2"></i> TOTAL DEPOSIT</h3>
        <i class="fas fa-wallet text-muted"></i>
      </div>
      <div class="stat-value display-6 fw-bold mt-2 text-white">
        $<%= wallet.investmentStats?.totalDeposit?.toFixed(2) || "0.00" %>
      </div>
      <hr class="my-3 text-secondary opacity-25" />
      <div class="crypto-breakdown text-muted small">
        <div class="crypto-item mb-1">
          <i class="fab fa-bitcoin text-warning"></i>
          Bitcoin: <strong><%= wallet.investmentStats?.depositBreakdown?.BTC || 0 %></strong>
        </div>
        <div class="crypto-item">
          <i class="fab fa-ethereum text-primary"></i>
          Ethereum: <strong><%= wallet.investmentStats?.depositBreakdown?.ETH || 0 %></strong>
        </div>
      </div>
    </div>

    <!-- TOTAL WITHDRAWAL -->
    <div class="stat-card withdrawal-card glass-card">
      <div class="stat-header d-flex align-items-center justify-content-between">
        <h3 class="fw-bold text-danger"><i class="fas fa-arrow-up me-2"></i> TOTAL WITHDRAWAL</h3>
        <i class="fas fa-university text-muted"></i>
      </div>
      <div class="stat-value display-6 fw-bold mt-2 text-white">
        $<%= wallet.investmentStats?.totalWithdrawal?.toFixed(2) || "0.00" %>
      </div>
      <hr class="my-3 text-secondary opacity-25" />
      <div class="crypto-breakdown text-muted small">
        <div class="crypto-item mb-1">
          <i class="fab fa-bitcoin text-warning"></i>
          Bitcoin: <strong><%= wallet.investmentStats?.withdrawalBreakdown?.BTC || 0 %></strong>
        </div>
        <div class="crypto-item">
          <i class="fab fa-ethereum text-primary"></i>
          Ethereum: <strong><%= wallet.investmentStats?.withdrawalBreakdown?.ETH || 0 %></strong>
        </div>
      </div>
    </div>
  </div>
</section>




  <!-- QUICK ACTIONS -->
  <section class="quick-actions">
    <h3>Quick Actions</h3>
    <div class="action-buttons">
      <a href="/dashboard/wallet/deposit" class="action-btn deposit-btn">
        <i class="fas fa-arrow-down"></i> Deposit
      </a>
      <a href="/dashboard/wallet/withdraw" class="action-btn withdraw-btn">
        <i class="fas fa-arrow-up"></i> Withdraw
      </a>
      <a href="/dashboard/trade" class="action-btn invest-btn">
        <i class="fas fa-chart-line"></i> Invest
      </a>
      <a href="/dashboard/wallet" class="action-btn transactions-btn">
        <i class="fas fa-history"></i> Transactions
      </a>
    </div>
  </section>


</section>
</div>

<!-- DASHBOARD SCRIPT -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Toggle balance visibility
  const toggleBtn = document.getElementById('toggleBalance');
  const balanceAmount = document.getElementById('balanceAmount');
  let isHidden = false;

  toggleBtn?.addEventListener('click', () => {
    isHidden = !isHidden;
    if (isHidden) {
      balanceAmount.textContent = '******';
      toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
    } else {
      loadDashboardData();
      toggleBtn.innerHTML = '<i class="fas fa-eye"></i>';
    }
  });

  // Load initial data
  loadDashboardData();

  // Auto-refresh every 30 seconds
  setInterval(loadDashboardData, 30000);
});

async function loadDashboardData() {
  try {
    const response = await fetch('/api/wallet');
    const data = await response.json();

    if (data.success && !isHidden) {
      // BALANCE
      document.getElementById('balanceAmount').textContent = 
        data.wallet.totalBalance.toLocaleString(undefined, { minimumFractionDigits: 2 });
      
      document.getElementById('btc-holding').textContent = 
        data.wallet.BTC.holding.toFixed(6);
      
      document.getElementById('eth-holding').textContent = 
        data.wallet.ETH.holding.toFixed(4);

      // ASSET TABLE (from previous)
      updateAssetTable(data.wallet);
    }
  } catch (error) {
    console.error('Dashboard load error:', error);
  }

  // Load transaction stats
  loadTransactionStats();
}

async function loadTransactionStats() {
  try {
    const response = await fetch('/api/transactions/stats');
    const stats = await response.json();

    if (stats.success) {
      // PROFIT RETURN
      document.getElementById('profit-return').textContent = 
        stats.profitReturn.toLocaleString(undefined, { minimumFractionDigits: 2 });

      // BONUS
      document.getElementById('bonus-amount').textContent = 
        stats.bonus.toLocaleString(undefined, { minimumFractionDigits: 2 });
      document.getElementById('bonus-btc').textContent = stats.bonusBTC.toFixed(6);
      document.getElementById('bonus-eth').textContent = stats.bonusETH.toFixed(4);

      // TOTAL DEPOSIT
      document.getElementById('total-deposit').textContent = 
        stats.totalDeposit.toLocaleString(undefined, { minimumFractionDigits: 2 });
      document.getElementById('deposit-btc').textContent = stats.depositBTC.toFixed(6);
      document.getElementById('deposit-eth').textContent = stats.depositETH.toFixed(4);

      // TOTAL WITHDRAWAL
      document.getElementById('total-withdrawal').textContent = 
        stats.totalWithdrawal.toLocaleString(undefined, { minimumFractionDigits: 2 });
      document.getElementById('withdrawal-btc').textContent = stats.withdrawalBTC.toFixed(6);
      document.getElementById('withdrawal-eth').textContent = stats.withdrawalETH.toFixed(4);
    }
  } catch (error) {
    console.error('Stats load error:', error);
  }
}
</script>