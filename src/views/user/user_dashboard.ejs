<%- layout('layout/acctBoilerplate', { title: 'xInvest - Dashboard' }) %> <%-
partial("partials/floatingNav") %> <%- partial('partials/sideBar') %>



<div class="dashboard">
  <!-- VERIFICATION MESSAGE -->
  <% if (!user.verified) { %>
  <div class="verification-banner">
    <div class="banner-content">
      <i class="fas fa-exclamation-triangle"></i>
      <div>
        <h3>Account Not Yet Verified!</h3>
        <p>Document verification is required to complete registration</p>
      </div>
      <a href="/verify" class="verify-btn">
        <i class="fas fa-upload"></i> Upload Document
      </a>
    </div>
  </div>
  <% } %>

  <section class="dashboard-stats">
    <!-- BALANCE CARD -->
    <div class="stat-card balance-card">
      <div class="stat-header">
        <i class="fas fa-wallet"></i>
        <h3>BALANCE</h3>
      </div>
      <div class="stat-value">
        $<span id="balanceAmount">0.00</span>
      </div>
      <div class="crypto-breakdown">
        <div class="crypto-item">
          <i class="fab fa-bitcoin"></i>
          <span>Bitcoin: <strong id="btc-holding">0</strong></span>
        </div>
        <div class="crypto-item">
          <i class="fab fa-ethereum"></i>
          <span>Ethereum: <strong id="eth-holding">0</strong></span>
        </div>
      </div>
    </div>

    <!-- PROFIT RETURN CARD -->
    <div class="stat-card profit-card">
      <div class="stat-header">
        <i class="fas fa-chart-line"></i>
        <h3>PROFIT RETURN</h3>
      </div>
      <div class="stat-value profit-value">
        $<span id="profit-return">0.00</span>
      </div>
    </div>

    <!-- BONUS CARD -->
    <div class="stat-card bonus-card">
      <div class="stat-header">
        <i class="fas fa-gift"></i>
        <h3>BONUS</h3>
      </div>
      <div class="stat-value bonus-value">
        $<span id="bonus-amount">0.00</span>
      </div>
      <div class="crypto-breakdown">
        <div class="crypto-item">
          <i class="fab fa-bitcoin"></i>
          <span>Bitcoin: <strong id="bonus-btc">0</strong></span>
        </div>
        <div class="crypto-item">
          <i class="fab fa-ethereum"></i>
          <span>Ethereum: <strong id="bonus-eth">0</strong></span>
        </div>
      </div>
    </div>
  </section>

  <!-- INVESTMENT STATS -->
  <section class="investment-stats">
    <div class="stat-row">
      <div class="stat-card deposit-card">
        <div class="stat-header">
          <i class="fas fa-arrow-down"></i>
          <h3>TOTAL DEPOSIT</h3>
        </div>
        <div class="stat-value">
          $<span id="total-deposit">0.00</span>
        </div>
        <div class="crypto-breakdown">
          <div class="crypto-item"><i class="fab fa-bitcoin"></i> Bitcoin: <strong id="deposit-btc">0</strong></div>
          <div class="crypto-item"><i class="fab fa-ethereum"></i> Ethereum: <strong id="deposit-eth">0</strong></div>
        </div>
      </div>

      <div class="stat-card withdrawal-card">
        <div class="stat-header">
          <i class="fas fa-arrow-up"></i>
          <h3>TOTAL WITHDRAWAL</h3>
        </div>
        <div class="stat-value">
          $<span id="total-withdrawal">0.00</span>
        </div>
        <div class="crypto-breakdown">
          <div class="crypto-item"><i class="fab fa-bitcoin"></i> Bitcoin: <strong id="withdrawal-btc">0</strong></div>
          <div class="crypto-item"><i class="fab fa-ethereum"></i> Ethereum: <strong id="withdrawal-eth">0</strong></div>
        </div>
      </div>
    </div>
  </section>

  <!-- QUICK ACTIONS -->
  <section class="quick-actions">
    <h3>Quick Actions</h3>
    <div class="action-buttons">
      <a href="/deposit" class="action-btn deposit-btn">
        <i class="fas fa-arrow-down"></i> Deposit
      </a>
      <a href="/withdraw" class="action-btn withdraw-btn">
        <i class="fas fa-arrow-up"></i> Withdraw
      </a>
      <a href="/invest" class="action-btn invest-btn">
        <i class="fas fa-chart-line"></i> Invest
      </a>
      <a href="/transactions" class="action-btn transactions-btn">
        <i class="fas fa-history"></i> Transactions
      </a>
    </div>
  </section>


</section>
</div>

<!-- DASHBOARD SCRIPT -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Toggle balance visibility
  const toggleBtn = document.getElementById('toggleBalance');
  const balanceAmount = document.getElementById('balanceAmount');
  let isHidden = false;

  toggleBtn?.addEventListener('click', () => {
    isHidden = !isHidden;
    if (isHidden) {
      balanceAmount.textContent = '******';
      toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
    } else {
      loadDashboardData();
      toggleBtn.innerHTML = '<i class="fas fa-eye"></i>';
    }
  });

  // Load initial data
  loadDashboardData();

  // Auto-refresh every 30 seconds
  setInterval(loadDashboardData, 30000);
});

async function loadDashboardData() {
  try {
    const response = await fetch('/api/wallet');
    const data = await response.json();

    if (data.success && !isHidden) {
      // BALANCE
      document.getElementById('balanceAmount').textContent = 
        data.wallet.totalBalance.toLocaleString(undefined, { minimumFractionDigits: 2 });
      
      document.getElementById('btc-holding').textContent = 
        data.wallet.BTC.holding.toFixed(6);
      
      document.getElementById('eth-holding').textContent = 
        data.wallet.ETH.holding.toFixed(4);

      // ASSET TABLE (from previous)
      updateAssetTable(data.wallet);
    }
  } catch (error) {
    console.error('Dashboard load error:', error);
  }

  // Load transaction stats
  loadTransactionStats();
}

async function loadTransactionStats() {
  try {
    const response = await fetch('/api/transactions/stats');
    const stats = await response.json();

    if (stats.success) {
      // PROFIT RETURN
      document.getElementById('profit-return').textContent = 
        stats.profitReturn.toLocaleString(undefined, { minimumFractionDigits: 2 });

      // BONUS
      document.getElementById('bonus-amount').textContent = 
        stats.bonus.toLocaleString(undefined, { minimumFractionDigits: 2 });
      document.getElementById('bonus-btc').textContent = stats.bonusBTC.toFixed(6);
      document.getElementById('bonus-eth').textContent = stats.bonusETH.toFixed(4);

      // TOTAL DEPOSIT
      document.getElementById('total-deposit').textContent = 
        stats.totalDeposit.toLocaleString(undefined, { minimumFractionDigits: 2 });
      document.getElementById('deposit-btc').textContent = stats.depositBTC.toFixed(6);
      document.getElementById('deposit-eth').textContent = stats.depositETH.toFixed(4);

      // TOTAL WITHDRAWAL
      document.getElementById('total-withdrawal').textContent = 
        stats.totalWithdrawal.toLocaleString(undefined, { minimumFractionDigits: 2 });
      document.getElementById('withdrawal-btc').textContent = stats.withdrawalBTC.toFixed(6);
      document.getElementById('withdrawal-eth').textContent = stats.withdrawalETH.toFixed(4);
    }
  } catch (error) {
    console.error('Stats load error:', error);
  }
}
</script>