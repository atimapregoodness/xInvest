<%- layout('layout/adminBoilerplate') %>

<div class="row g-4 w-100">
  <!-- Verification Requests -->
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm border-0 h-100" id="div">
      <div
        class="card-header bg-dark text-white d-flex justify-content-between align-items-center"
      >
        <h6 class="mb-0">
          <i class="fa-solid fa-user-check me-2 text-primary"></i>User
          Verifications
        </h6>
        <span id="verCount" class="badge bg-primary">
          <%= verifications.length %>
        </span>
      </div>

      <div class="card-body" id="verificationsDropdown">
        <% if (verifications.length > 0) { %>
        <div class="dropdown w-100">
          <button
            class="btn btn-primary dropdown-toggle w-100"
            type="button"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            Pending Verifications (<%= verifications.length %>)
          </button>

          <ul
            class="dropdown-menu w-100 p-2"
            style="max-height: 400px; overflow-y: auto"
          >
            <% verifications.forEach(req => { %>
            <li class="mb-2">
              <div class="card shadow-sm border-0">
                <div class="card-body p-3">
                  <div
                    class="d-flex justify-content-between align-items-center"
                  >
                    <div>
                      <h6 class="mb-1 fw-semibold text-light">
                        <%= req.user.fullName %>
                      </h6>
                      <p class="mb-1 text-light small">
                        <i class="fa-solid fa-envelope me-1"></i><%=
                        req.user.email %>
                      </p>
                      <p class="mb-0 text-light small">
                        <i class="fa-solid fa-id-card me-1"></i><%= req.idType
                        %> • <%= new Date(req.createdAt).toLocaleDateString() %>
                      </p>
                    </div>
                    <div class="dropdown">
                      <button
                        class="btn btn-sm btn-outline-secondary dropdown-toggle"
                        data-bs-toggle="dropdown"
                      >
                        <i class="fa-solid fa-ellipsis-vertical"></i>
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                          <a
                            href="<%= req.idImage %>"
                            target="_blank"
                            class="dropdown-item text-info"
                          >
                            <i class="fa-solid fa-eye me-2"></i> View ID
                          </a>
                        </li>
                        <li>
                          <a
                            href="/admin/verify/approve/<%= req._id %>"
                            class="dropdown-item text-success"
                          >
                            <i class="fa-solid fa-check me-2"></i> Approve
                          </a>
                        </li>
                        <li>
                          <a
                            href="/admin/verify/reject/<%= req._id %>"
                            class="dropdown-item text-danger"
                          >
                            <i class="fa-solid fa-times me-2"></i> Reject
                          </a>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </li>
            <% }) %>
          </ul>
        </div>
        <% } else { %>
        <div class="p-4 text-center text-muted">
          <i class="fa-regular fa-circle-info fa-2x mb-2 d-block"></i>
          No pending verification requests.
        </div>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Deposit Requests -->
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm border-0 h-100" id="div">
      <div
        class="card-header bg-dark text-white d-flex justify-content-between align-items-center"
      >
        <h6 class="mb-0">
          <i class="fa-solid fa-wallet me-2 text-warning"></i>Deposit Requests
        </h6>
        <span id="depCount" class="badge bg-warning text-dark">
          <%= deposits.length %>
        </span>
      </div>

      <div class="card-body p-0" id="depositsTable">
        <% if (deposits.length > 0) { %>
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0 text-nowrap">
            <thead class="table-light">
              <tr>
                <th>User</th>
                <th>Amount</th>
                <th>Currency</th>
                <th>Date</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <% deposits.forEach(dep => { %>
              <tr>
                <td class="text-truncate text-light" style="max-width: 120px">
                  <%= dep.user.fullName %>
                </td>
                <td class="text-success">$<%= dep.amount.toFixed(2) %></td>
                <td class="text-light"><%= dep.currency %></td>
                <td class="text-light">
                  <%= new Date(dep.createdAt).toLocaleDateString() %>
                </td>
                <td>
                  <div class="dropdown">
                    <button
                      class="btn btn-sm btn-outline-secondary dropdown-toggle"
                      type="button"
                      data-bs-toggle="dropdown"
                      aria-expanded="false"
                    >
                      <i class="fa-solid fa-ellipsis-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                      <li>
                        <a
                          href="<%= dep.receipt %>"
                          target="_blank"
                          class="dropdown-item text-info"
                        >
                          <i class="fa-solid fa-receipt me-2"></i>View Receipt
                        </a>
                      </li>
                      <li>
                        <a
                          href="/admin/deposit/approve/<%= dep._id %>"
                          class="dropdown-item text-success"
                        >
                          <i class="fa-solid fa-check me-2"></i>Approve
                        </a>
                      </li>
                      <li>
                        <a
                          href="/admin/deposit/reject/<%= dep._id %>"
                          class="dropdown-item text-danger"
                        >
                          <i class="fa-solid fa-times me-2"></i>Reject
                        </a>
                      </li>
                    </ul>
                  </div>
                </td>
              </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
        <% } else { %>
        <div class="p-4 text-center text-muted">
          <i class="fa-regular fa-circle-info fa-2x mb-2 d-block"></i>
          No pending deposit requests.
        </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- ✅ Real-time Updates -->
<script src="/socket.io/socket.io.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const socket = io();

    socket.on("updateRequests", async (data) => {
      try {
        if (data.verifications) {
          document.getElementById("verCount").textContent =
            data.verifications.length;
          const res = await fetch("/admin/requests/partial/verifications");
          const html = await res.text();
          document.getElementById("verificationsTable").innerHTML = html;
        }

        if (data.deposits) {
          document.getElementById("depCount").textContent =
            data.deposits.length;
          const res = await fetch("/admin/requests/partial/deposits");
          const html = await res.text();
          document.getElementById("depositsTable").innerHTML = html;
        }
      } catch (err) {
        console.error("Error updating tables:", err);
      }
    });
  });
</script>
