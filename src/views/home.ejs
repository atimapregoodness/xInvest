<%- layout('layout/boilerplate', { title: 'xInvest - Home' }) %>

<!-- ===================== ENHANCED HERO SECTION ===================== -->
<section
  class="hero-section hero-gradient text-white py-5 position-relative"
  id="firstSection"
>
  <!-- Live Ticker -->
  <div class="live-ticker d-flex align-items-center">
    <span class="live-indicator"></span>
    <div class="ticker-container">
      <div class="ticker-text" id="liveTickerText">
        <!-- Filled dynamically -->
      </div>
    </div>
  </div>

  <div class="container position-relative z-1">
    <div class="row align-items-center min-vh-80">
      <div class="col-lg-6">
        <div class="fade-in">
          <span class="pro-badge mb-3 d-inline-block">
            <span class="live-indicator"></span>
            INSTITUTIONAL FOREX PLATFORM
          </span>
          <h1 class="display-3 fw-bold mb-4">
            Professional
            <span class="text-accent">Forex Investment</span> Solutions
          </h1>
          <p class="lead text-light mb-4 fs-5">
            Access institutional-grade forex trading with lightning-fast
            execution, razor-thin spreads, and professional portfolio
            management.
          </p>

          <!-- Enhanced Stats -->
          <div class="row g-3 mb-4">
            <div class="col-md-4">
              <div class="glass-card p-3 text-center">
                <div class="stat-number">15K+</div>
                <small class="text-muted">Professional Traders</small>
              </div>
            </div>
            <div class="col-md-4">
              <div class="glass-card p-3 text-center">
                <div class="stat-number">$2.8B+</div>
                <small class="text-muted">Daily Volume</small>
              </div>
            </div>
            <div class="col-md-4">
              <div class="glass-card p-3 text-center">
                <div class="stat-number">99.2%</div>
                <small class="text-muted">Execution Rate</small>
              </div>
            </div>
          </div>

          <div class="d-flex flex-wrap gap-3">
            <a href="/auth/register" class="btn btn-accent btn-lg px-5 py-3">
              <i class="fas fa-rocket me-2"></i>Start Trading
            </a>
            <a
              href="#institutional-features"
              class="btn btn-outline-light btn-lg px-5 py-3"
            >
              <i class="fas fa-chart-line me-2"></i>View Platform
            </a>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <!-- Professional Live Forex Widget -->
        <div class="glass-card p-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
              <i class="fas fa-bolt text-accent me-2"></i>
              Live Market Prices
            </h5>
            <span class="text-success small">
              <span class="live-indicator"></span>
              Real-time
            </span>
          </div>
          <div class="market-depth"></div>
          <div id="live-forex-widget">
            <!-- Data will be populated by JavaScript -->
          </div>
          <div class="text-center mt-3">
            <small class="text-muted"
              >Powered by OneZero Technology • Equinix NY4/TY3</small
            >
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ===================== INSTITUTIONAL FEATURES ===================== -->
<section id="institutional-features" class="py-5 bg-dark">
  <div class="container">
    <div class="text-center mb-5">
      <span class="pro-badge mb-3">INSTITUTIONAL TECHNOLOGY</span>
      <h2 class="fw-bold text-white mb-3">Lightning Speed Execution</h2>
      <p class="lead text-muted">
        Professional trading conditions with institutional infrastructure
      </p>
    </div>

    <div class="feature-grid">
      <!-- Feature 1: Lightning Execution -->
      <div class="institutional-feature">
        <div class="feature-icon">
          <i class="fas fa-bolt fa-2x text-white"></i>
        </div>
        <h4 class="text-white mb-3">Lightning Execution</h4>
        <p class="text-light mb-3">
          Ultra-fast trade execution with razor-thin spreads starting from 0.1
          pips
        </p>
        <div class="glass-card p-3 text-center mt-3">
          <div class="row text-center">
            <div class="col-6">
              <small class="text-muted d-block">Bid</small>
              <strong class="text-success">1.10005</strong>
            </div>
            <div class="col-6">
              <small class="text-muted d-block">Ask</small>
              <strong class="text-danger">1.10006</strong>
            </div>
          </div>
          <div class="mt-2">
            <span class="badge bg-accent text-dark">Spread: 0.1 pips</span>
          </div>
        </div>
        <ul class="list-unstyled mt-3">
          <li class="text-muted mb-2">
            <i class="fas fa-check text-success me-2"></i>Top-tier Liquidity
            Providers
          </li>
          <li class="text-muted mb-2">
            <i class="fas fa-check text-success me-2"></i>OneZero Financial
            Technology
          </li>
          <li class="text-muted">
            <i class="fas fa-check text-success me-2"></i>Equinix NY4 & TY3 Data
            Centers
          </li>
        </ul>
      </div>

      <!-- Feature 2: Expert Advisor Environment -->
      <div class="institutional-feature">
        <div class="feature-icon">
          <i class="fas fa-robot fa-2x text-white"></i>
        </div>
        <h4 class="text-white mb-3">Perfect EA Environment</h4>
        <p class="text-light mb-3">
          Optimized platform for Expert Advisors with maximum flexibility
        </p>
        <div class="glass-card p-3 mt-3">
          <div class="row text-center">
            <div class="col-6 mb-3">
              <i class="fas fa-tachometer-alt text-accent fa-2x mb-2"></i>
              <div class="text-muted small">Scalping</div>
            </div>
            <div class="col-6 mb-3">
              <i class="fas fa-sync-alt text-accent fa-2x mb-2"></i>
              <div class="text-muted small">Hedging</div>
            </div>
            <div class="col-6">
              <i class="fas fa-newspaper text-accent fa-2x mb-2"></i>
              <div class="text-muted small">News Trading</div>
            </div>
            <div class="col-6">
              <i class="fas fa-ban text-accent fa-2x mb-2"></i>
              <div class="text-muted small">No Requotes</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Feature 3: Payments & Security -->
      <div class="institutional-feature">
        <div class="feature-icon">
          <i class="fas fa-shield-alt fa-2x text-white"></i>
        </div>
        <h4 class="text-white mb-3">Secure Banking</h4>
        <p class="text-light mb-3">
          Instant deposits and fast withdrawals with top-tier security
        </p>
        <div class="glass-card p-3 mt-3">
          <div class="row text-center mb-3">
            <div class="col-4">
              <i class="fab fa-cc-visa text-muted fa-2x"></i>
            </div>
            <div class="col-4">
              <i class="fab fa-cc-mastercard text-muted fa-2x"></i>
            </div>
            <div class="col-4">
              <i class="fab fa-cc-paypal text-muted fa-2x"></i>
            </div>
          </div>
          <div class="text-center">
            <small class="text-muted">Funds secured in Tier 1 banks</small>
          </div>
        </div>
        <div class="mt-3">
          <span class="badge bg-success me-2">FCA Regulated</span>
          <span class="badge bg-info">CySEC Licensed</span>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ===================== PRODUCT DIVERSIFICATION ===================== -->
<section class="py-5 gradient-bg">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-lg-6">
        <span class="pro-badge mb-3">15,000+ PRODUCTS</span>
        <h2 class="fw-bold text-white mb-4">
          Diversify Across 7 Asset Classes
        </h2>
        <p class="text-light lead mb-4">
          Access a comprehensive range of trading instruments with single
          account convenience. Trade Forex, Futures, Indices, Metals, Energies,
          and Shares.
        </p>

        <div class="row g-3">
          <div class="col-6">
            <div class="glass-card p-3 text-center">
              <i class="fas fa-globe-americas text-accent fa-2x mb-2"></i>
              <div class="text-white fw-bold">80+</div>
              <small class="text-muted">Forex Pairs</small>
            </div>
          </div>
          <div class="col-6">
            <div class="glass-card p-3 text-center">
              <i class="fas fa-chart-bar text-accent fa-2x mb-2"></i>
              <div class="text-white fw-bold">50+</div>
              <small class="text-muted">Stock Indices</small>
            </div>
          </div>
          <div class="col-6">
            <div class="glass-card p-3 text-center">
              <i class="fas fa-gem text-accent fa-2x mb-2"></i>
              <div class="text-white fw-bold">12+</div>
              <small class="text-muted">Precious Metals</small>
            </div>
          </div>
          <div class="col-6">
            <div class="glass-card p-3 text-center">
              <i class="fas fa-bolt text-accent fa-2x mb-2"></i>
              <div class="text-white fw-bold">8+</div>
              <small class="text-muted">Energy Products</small>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="glass-card p-4 mt-5 mt-lg-0">
          <h5 class="text-white mb-4">Competitive Pricing</h5>
          <div class="row g-3">
            <div class="col-6">
              <div class="forex-pair-card text-center">
                <div class="text-accent fw-bold">UK 100</div>
                <div class="text-white">from 0.8 pts</div>
              </div>
            </div>
            <div class="col-6">
              <div class="forex-pair-card text-center">
                <div class="text-accent fw-bold">Germany 30</div>
                <div class="text-white">from 0.9 pts</div>
              </div>
            </div>
            <div class="col-6">
              <div class="forex-pair-card text-center">
                <div class="text-accent fw-bold">EUR/USD</div>
                <div class="text-white">from 0.6 pips</div>
              </div>
            </div>
            <div class="col-6">
              <div class="forex-pair-card text-center">
                <div class="text-accent fw-bold">EUR/GBP</div>
                <div class="text-white">from 0.8 pips</div>
              </div>
            </div>
          </div>
          <div class="text-center mt-4">
            <small class="text-muted"
              >Depth of market available on all forex pairs</small
            >
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ===================== LIVE FOREX MARKET ===================== -->
<section class="py-5 bg-dark">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="fw-bold text-white">
        <span class="live-indicator"></span>
        Professional Market Watch
      </h2>
      <div class="text-muted small">
        Real-time updates • <span id="last-update">Loading...</span>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-8">
        <div class="glass-card p-4">
          <h5 class="text-white mb-4">
            <i class="fas fa-exchange-alt text-accent me-2"></i>
            Live Currency Pairs
          </h5>
          <div class="table-responsive">
            <table class="table table-dark table-hover table-borderless">
              <thead class="bg-accent text-dark">
                <tr>
                  <th>Instrument</th>
                  <th>Bid/Ask</th>
                  <th>Change</th>
                  <th>High/Low</th>
                  <th>Spread</th>
                  <th>Trade</th>
                </tr>
              </thead>
              <tbody id="forex-pairs-table">
                <!-- Data will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="glass-card p-4 h-100">
          <h5 class="text-white mb-4">
            <i class="fas fa-chart-pie text-accent me-2"></i>
            Market Overview
          </h5>
          <div class="mb-4">
            <h6 class="text-muted mb-2">Market Sentiment</h6>
            <div class="progress mb-2" style="height: 8px">
              <div class="progress-bar bg-success" style="width: 68%"></div>
            </div>
            <small class="text-muted">68% Bullish • 32% Bearish</small>
          </div>

          <div class="mb-4">
            <h6 class="text-muted mb-2">Volatility Index</h6>
            <div class="d-flex align-items-center">
              <div class="progress flex-grow-1 me-3" style="height: 8px">
                <div class="progress-bar bg-warning" style="width: 52%"></div>
              </div>
              <span class="text-warning small">Medium</span>
            </div>
          </div>

          <div class="mb-4">
            <h6 class="text-muted mb-2">Trading Sessions</h6>
            <div class="d-flex justify-content-between small mb-1">
              <span class="text-success">London</span>
              <span class="text-success">● Active</span>
            </div>
            <div class="d-flex justify-content-between small mb-1">
              <span class="text-warning">New York</span>
              <span class="text-warning">● Opening</span>
            </div>
            <div class="d-flex justify-content-between small">
              <span class="text-muted">Tokyo</span>
              <span class="text-muted">● Closed</span>
            </div>
          </div>

          <div class="text-center mt-4">
            <a href="/auth/register" class="btn btn-accent btn-sm">
              <i class="fas fa-play me-2"></i>Start Trading
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ===================== TRADING ACCOUNTS ===================== -->
<section class="py-5 gradient-bg">
  <div class="container">
    <div class="text-center mb-5">
      <span class="pro-badge mb-3">TRADING SOLUTIONS</span>
      <h2 class="fw-bold text-white">Professional Trading Accounts</h2>
      <p class="text-light lead">
        Tailored solutions for every trading style and experience level
      </p>
    </div>

    <div class="row g-4">
      <div class="col-md-6">
        <div class="glass-card p-4 h-100">
          <div class="feature-icon" style="width: 60px; height: 60px">
            <i class="fas fa-user text-white"></i>
          </div>
          <h4 class="text-white mb-3">Individual Accounts</h4>
          <p class="text-light mb-4">
            Comprehensive trading solutions for retail traders, scalpers, and
            day traders. Perfect for both manual trading and Expert Advisors.
          </p>
          <ul class="list-unstyled">
            <li class="text-light mb-2">
              <i class="fas fa-check text-success me-2"></i>All trading styles
              supported
            </li>
            <li class="text-light mb-2">
              <i class="fas fa-check text-success me-2"></i>EA and algorithmic
              trading
            </li>
            <li class="text-light mb-2">
              <i class="fas fa-check text-success me-2"></i>Advanced charting
              tools
            </li>
            <li class="text-light">
              <i class="fas fa-check text-success me-2"></i>Multiple platform
              access
            </li>
          </ul>
        </div>
      </div>

      <div class="col-md-6">
        <div class="glass-card p-4 h-100">
          <div class="feature-icon" style="width: 60px; height: 60px">
            <i class="fas fa-users text-white"></i>
          </div>
          <h4 class="text-white mb-3">Fund Manager Program</h4>
          <p class="text-light mb-4">
            Build and manage your investment fund with our proprietary copy
            trading system and investor management tools.
          </p>
          <ul class="list-unstyled">
            <li class="text-light mb-2">
              <i class="fas fa-check text-success me-2"></i>Proprietary copy
              trading
            </li>
            <li class="text-light mb-2">
              <i class="fas fa-check text-success me-2"></i>Investor management
              portal
            </li>
            <li class="text-light mb-2">
              <i class="fas fa-check text-success me-2"></i>Performance
              analytics
            </li>
            <li class="text-light">
              <i class="fas fa-check text-success me-2"></i>Revenue sharing
              models
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ===================== INVESTMENT PORTFOLIOS ===================== -->
<section class="py-5 bg-dark">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-lg-6">
        <div class="glass-card p-4">
          <span class="pro-badge mb-3">xInvest INSIGHTS</span>
          <h3 class="text-white mb-4">Curated Investment Portfolios</h3>
          <p class="text-light mb-4">
            Diversify your investments with carefully screened and curated
            portfolios of global stocks, ETFs, and futures markets.
          </p>

          <div class="row g-3 mb-4">
            <div class="col-6">
              <div class="text-center">
                <i class="fas fa-filter text-accent fa-2x mb-2"></i>
                <div class="text-white fw-bold">AI-Screened</div>
                <small class="text-muted">Market Analysis</small>
              </div>
            </div>
            <div class="col-6">
              <div class="text-center">
                <i class="fas fa-chart-line text-accent fa-2x mb-2"></i>
                <div class="text-white fw-bold">Expert Curated</div>
                <small class="text-muted">Portfolio Selection</small>
              </div>
            </div>
          </div>

          <div class="d-flex gap-2">
            <a href="/auth/register" class="btn btn-accent">
              <i class="fas fa-rocket me-2"></i>Get Started
            </a>
            <a href="#investment-plans" class="btn btn-outline-light">
              View Portfolios
            </a>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="glass-card p-4 mt-5 mt-lg-0">
          <h5 class="text-white mb-4">Why Professional Traders Choose Us</h5>
          <div class="row g-3">
            <div class="col-6">
              <div class="text-center p-3">
                <div class="display-6 fw-bold text-accent">23</div>
                <small class="text-muted">Years Experience</small>
              </div>
            </div>
            <div class="col-6">
              <div class="text-center p-3">
                <div class="display-6 fw-bold text-accent">15K+</div>
                <small class="text-muted">Products</small>
              </div>
            </div>
            <div class="col-6">
              <div class="text-center p-3">
                <div class="display-6 fw-bold text-accent">99.2%</div>
                <small class="text-muted">Uptime</small>
              </div>
            </div>
            <div class="col-6">
              <div class="text-center p-3">
                <div class="display-6 fw-bold text-accent">24/7</div>
                <small class="text-muted">Support</small>
              </div>
            </div>
          </div>

          <div class="text-center mt-4">
            <small class="text-muted">
              Globally recognized • API integration • Automated strategies
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ===================== INVESTMENT PLANS ===================== -->
<section id="investment-plans" class="py-5 gradient-bg">
  <div class="container">
    <div class="text-center mb-5">
      <span class="pro-badge mb-3">INVESTMENT STRATEGIES</span>
      <h2 class="fw-bold text-white">Professional Investment Plans</h2>
      <p class="text-light lead">
        Structured investment solutions for consistent returns
      </p>
    </div>

    <div class="row g-4">
      <!-- Conservative Plan -->
      <div class="col-md-4">
        <div class="plan-card text-center">
          <span class="badge bg-secondary mb-3">CONSERVATIVE</span>
          <h4 class="fw-bold text-accent">Wealth Builder</h4>
          <div class="my-4">
            <span class="h1 fw-bold text-white">5.8%</span>
            <span class="text-muted">/month</span>
          </div>
          <ul class="list-unstyled mb-4">
            <li class="mb-2">
              <i class="fas fa-check text-success me-2"></i>Minimum: $1,000
            </li>
            <li class="mb-2">
              <i class="fas fa-check text-success me-2"></i>3 Month Duration
            </li>
            <li class="mb-2">
              <i class="fas fa-check text-success me-2"></i>Capital Protection
            </li>
            <li class="mb-2">
              <i class="fas fa-check text-success me-2"></i>Daily Compounding
            </li>
            <li class="mb-2">
              <i class="fas fa-times text-muted me-2"></i>Priority Support
            </li>
          </ul>
          <button
            class="btn btn-outline-accent w-100"
            onclick="openInvestModal('conservative', 1000)"
          >
            Start Investing
          </button>
        </div>
      </div>

      <!-- Professional Plan -->
      <div class="col-md-4">
        <div class="plan-card featured text-center">
          <span class="badge bg-warning text-dark mb-3">PROFESSIONAL</span>
          <h4 class="fw-bold">Premium Growth</h4>
          <div class="my-4">
            <span class="h1 fw-bold">9.2%</span>
            <span class="text-light">/month</span>
          </div>
          <ul class="list-unstyled mb-4">
            <li class="mb-2">
              <i class="fas fa-check text-light me-2"></i>Minimum: $10,000
            </li>
            <li class="mb-2">
              <i class="fas fa-check text-light me-2"></i>6 Month Duration
            </li>
            <li class="mb-2">
              <i class="fas fa-check text-light me-2"></i>Enhanced Protection
            </li>
            <li class="mb-2">
              <i class="fas fa-check text-light me-2"></i>Advanced Compounding
            </li>
            <li class="mb-2">
              <i class="fas fa-check text-light me-2"></i>Priority Support
            </li>
          </ul>
          <button
            class="btn btn-light w-100 fw-bold"
            onclick="openInvestModal('professional', 10000)"
          >
            Get Premium
          </button>
        </div>
      </div>

      <!-- Institutional Plan -->
      <div class="col-md-4">
        <div class="plan-card text-center">
          <span class="badge bg-warning text-dark mb-3">INSTITUTIONAL</span>
          <h4 class="fw-bold text-accent">Elite Portfolio</h4>
          <div class="my-4">
            <span class="h1 fw-bold text-white">13.5%</span>
            <span class="text-muted">/month</span>
          </div>
          <ul class="list-unstyled mb-4">
            <li class="mb-2">
              <i class="fas fa-check text-success me-2"></i>Minimum: $50,000
            </li>
            <li class="mb-2">
              <i class="fas fa-check text-success me-2"></i>12 Month Duration
            </li>
            <li class="mb-2">
              <i class="fas fa-check text-success me-2"></i>Full Capital
              Protection
            </li>
            <li class="mb-2">
              <i class="fas fa-check text-success me-2"></i>Maximum Compounding
            </li>
            <li class="mb-2">
              <i class="fas fa-check text-success me-2"></i>Dedicated Manager
            </li>
          </ul>
          <button
            class="btn btn-outline-accent w-100"
            onclick="openInvestModal('institutional', 50000)"
          >
            Elite Access
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ===================== ADVANCED CHARTING ===================== -->
<section class="py-5 bg-dark">
  <div class="container">
    <div class="text-center mb-5">
      <span class="pro-badge mb-3">PROFESSIONAL TOOLS</span>
      <h2 class="fw-bold text-white">Advanced Market Analysis</h2>
      <p class="text-muted">
        Institutional-grade charting and technical analysis tools
      </p>
    </div>

    <div class="row g-4">
      <div class="col-12">
        <div class="glass-card p-3">
          <!-- TradingView Advanced Chart -->
          <div class="tradingview-widget-container">
            <div id="advanced-chart" style="height: 500px"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ===================== CTA SECTION ===================== -->
<section class="py-5 gradient-bg text-center">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <h2 class="fw-bold mb-4">Start Your Professional Trading Journey</h2>
        <p class="lead text-light mb-4">
          Join thousands of successful traders who trust our institutional-grade
          platform for their forex trading and investment needs.
        </p>
        <div class="d-flex justify-content-center gap-3 flex-wrap">
          <a href="/auth/register" class="btn btn-accent btn-lg px-5 py-3">
            <i class="fas fa-user-plus me-2"></i>Create Account
          </a>
          <a href="/contact" class="btn btn-outline-light btn-lg px-5 py-3">
            <i class="fas fa-phone me-2"></i>Contact Sales
          </a>
        </div>
        <p class="text-muted mt-4 small">
          Get started in less than 3 minutes • Professional support 24/7
        </p>
      </div>
    </div>
  </div>
</section>

<!-- ===================== INVESTMENT MODAL ===================== -->
<div class="modal fade" id="investModal" tabindex="-1">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content glass-card">
      <div class="modal-header border-0">
        <h5 class="modal-title text-white" id="modal-plan-title">
          Invest in <span id="plan-name"></span>
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form id="invest-form">
          <input type="hidden" name="planType" id="modal-plan-type" />
          <div class="mb-4">
            <label class="form-label text-light">Investment Amount (USD)</label>
            <input
              type="number"
              class="form-control bg-dark text-light border-secondary"
              id="modal-amount"
              name="amount"
              min="0"
              step="100"
              required
            />
            <div class="form-text text-muted" id="min-amount-hint"></div>
          </div>
          <div class="mb-4">
            <label class="form-label text-light">Expected Monthly Return</label>
            <div class="glass-card p-3 text-center">
              <span class="h4 text-accent" id="expected-return">$0.00</span>
              <small class="text-muted d-block"
                >Based on selected investment plan</small
              >
            </div>
          </div>
          <button type="submit" class="btn btn-accent w-100 py-3 fw-bold">
            <i class="fas fa-lock me-2"></i>Secure Investment
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
<script>
  /* ========================= Combined Site JS (TradingView, Live Ticker, Live Forex Widgets) ========================= */
  (async function () {
    // --- Utility helpers ---
    const safe = (fn) => {
      try {
        return fn();
      } catch (e) {
        console.error(e);
        return null;
      }
    };

    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

    // Debounce util
    function debounce(fn, wait = 150) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), wait);
      };
    }

    // -------------------- DOM references (guarded) --------------------
    const tickerText = document.getElementById("liveTickerText");
    const tickerContainer = document.querySelector(".ticker-container");
    const liveForexWidget = document.getElementById("live-forex-widget");
    const forexPairsTable = document.getElementById("forex-pairs-table");
    const lastUpdateEl = document.getElementById("last-update");

    // -------------------- Symbols / config --------------------
    const forexPairs = [
      "EUR/USD",
      "GBP/USD",
      "USD/JPY",
      "AUD/USD",
      "USD/CAD",
      "NZD/USD",
      "USD/CHF",
      "EUR/GBP",
      "EUR/JPY",
      "GBP/JPY",
    ];
    const cryptoPairs = [
      "bitcoin",
      "ethereum",
      "bnb",
      "solana",
      "ripple",
      "dogecoin",
      "cardano",
      "litecoin",
      "tron",
      "polkadot",
    ];
    const stockSymbols = [
      "AAPL",
      "MSFT",
      "GOOGL",
      "AMZN",
      "TSLA",
      "META",
      "NFLX",
      "NVDA",
      "AMD",
      "INTC",
    ];

    // API endpoints
    const forexAPI = "https://api.exchangerate.host/latest?base=USD"; // no key
    const cryptoAPI =
      "https://api.coingecko.com/api/v3/simple/price?ids=" +
      cryptoPairs.join(",") +
      "&vs_currencies=usd";
    const stocksAPI =
      "https://query1.finance.yahoo.com/v7/finance/quote?symbols=" +
      stockSymbols.join(",");

    // If any of these fail often in your environment, swap to a server-side proxy to avoid CORS / rate limits.

    // -------------------- TradingView widget init (safe) --------------------
    function initTradingView() {
      // Only initialize if TradingView global exists and container is present
      const containerExists = document.getElementById("advanced-chart");
      if (typeof TradingView === "undefined" || !containerExists) {
        // If tv.js hasn't loaded yet, try again later (but don't loop forever)
        if (typeof TradingView === "undefined") {
          console.warn(
            "TradingView not loaded (tv.js). Skipping widget initialization."
          );
        }
        return;
      }

      try {
        // Remove any previous widget to avoid duplicates (defensive)
        safe(() => {
          if (containerExists._tv) {
            if (typeof containerExists._tv.remove === "function")
              containerExists._tv.remove();
          }
        });

        const widget = new TradingView.widget({
          container_id: "advanced-chart",
          autosize: true,
          symbol: "OANDA:EURUSD",
          interval: "15",
          timezone: "Etc/UTC",
          theme: "dark",
          style: "1",
          locale: "en",
          toolbar_bg: "#0e1117",
          enable_publishing: false,
          hide_top_toolbar: false,
          hide_legend: false,
          save_image: false,
          studies: [
            "RSI@tv-basicstudies",
            "MACD@tv-basicstudies",
            "BollingerBands@tv-basicstudies",
          ],
          support_host: "https://www.tradingview.com",
        });

        // store reference to optionally destroy later
        containerExists._tv = widget;
      } catch (err) {
        console.error("TradingView init error:", err);
      }
    }

    // Initialize TradingView (try once, and again after a short delay if tv.js arrives slightly later)
    initTradingView();
    // attempt again once in 1s if TradingView wasn't present yet
    setTimeout(initTradingView, 1000);

    // -------------------- Fetch helpers --------------------
    async function fetchJson(url, opts = {}) {
      try {
        const res = await fetch(url, opts);
        if (!res.ok) {
          throw new Error(`HTTP ${res.status} - ${res.statusText}`);
        }
        return await res.json();
      } catch (err) {
        console.error("fetchJson error for", url, err);
        return null;
      }
    }

    // Fetchers return arrays of formatted strings for ticker display (safe)
    async function fetchForexForTicker() {
      const json = await fetchJson(forexAPI);
      if (!json || !json.rates) return [];
      const rates = json.rates;
      return forexPairs.map((pair) => {
        const [a, b] = pair.split("/");
        // exchangerate.host returns rates relative to base (USD here)
        // to compute A/B when base=USD:
        // if pair is EUR/USD => need direct rates[EUR]? common approach: compute A/B = rateB ? (rates[A]/rates[B]) : ...
        // Simpler: compute A/B using rates object (rates[CUR] = 1 unit base -> CUR per USD)
        // robust approach: compute using ratios if both present
        const rateA = rates[a];
        const rateB = rates[b];
        let value = "—";
        if (rateA && rateB) {
          // a/b = (rateA per USD) / (rateB per USD) => rateA / rateB
          value = (rateA / rateB).toFixed(5);
        } else if (a === "USD" && rateB) {
          value = (1 / rateB).toFixed(5);
        } else if (b === "USD" && rateA) {
          value = rateA.toFixed(5);
        }
        return `${pair}: <strong>${value}</strong>`;
      });
    }

    async function fetchCryptoForTicker() {
      const json = await fetchJson(cryptoAPI);
      if (!json) return [];
      return Object.entries(json).map(
        ([k, v]) =>
          `${k.toUpperCase()}/USD: <strong>$${(v.usd || 0).toLocaleString(
            undefined,
            { maximumFractionDigits: 2 }
          )}</strong>`
      );
    }

    async function fetchStocksForTicker() {
      const json = await fetchJson(stocksAPI);
      if (
        !json ||
        !json.quoteResponse ||
        !Array.isArray(json.quoteResponse.result)
      )
        return [];
      return json.quoteResponse.result.map((q) => {
        const price =
          typeof q.regularMarketPrice !== "undefined"
            ? q.regularMarketPrice
            : "—";
        return `${q.symbol}: <strong>$${price}</strong>`;
      });
    }

    // -------------------- Live UI updates --------------------
    // Safe update ticker DOM
    function setTickerHtml(html) {
      if (!tickerText) return;
      tickerText.innerHTML = html;
    }

    // Adjust ticker speed based on width (throttled)
    const adjustTickerSpeed = debounce(() => {
      try {
        if (!tickerText || !tickerContainer) return;
        const baseSpeed = 120; // pixels per second - tweak as desired (higher = faster)
        const textWidth = tickerText.scrollWidth;
        const containerWidth = tickerContainer.offsetWidth;
        const duration = Math.max(8, (textWidth + containerWidth) / baseSpeed); // min 8s
        tickerText.style.animationDuration = `${duration}s`;
      } catch (err) {
        console.error("adjustTickerSpeed error:", err);
      }
    }, 120);

    // Update forex widget small cards
    function updateLiveForexWidget(pairsData) {
      if (!liveForexWidget) return;
      const majorPairs = ["EURUSD", "GBPUSD", "USDJPY", "USDCHF", "AUDUSD"];
      const html = majorPairs
        .map((pair) => {
          const key = pair.toUpperCase();
          const raw = pairsData && pairsData[key];
          const price = raw && raw.bid ? raw.bid : getInitialPrice(pair) || "—";
          return `
        <div class="forex-pair-card mb-3" data-pair="${pair}">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-1">${pair}</h6>
              <small class="text-muted">${getPairName(pair)}</small>
            </div>
            <div class="text-end">
              <h6 class="mb-1 live-price" id="${pair.toLowerCase()}-live">${price}</h6>
              <span class="price-up">+0.00%</span>
            </div>
          </div>
        </div>`;
        })
        .join("");
      liveForexWidget.innerHTML = html;
    }

    // Update forex pairs table (expects pairs object or will use generated)
    function updateForexTable(pairs = null) {
      if (!forexPairsTable) return;
      const data = pairs || generateProfessionalTableData();
      forexPairsTable.innerHTML = Object.entries(data)
        .map(([pair, d]) => {
          const changeClass = Number(d.change) >= 0 ? "price-up" : "price-down";
          const changeSymbol = Number(d.change) >= 0 ? "+" : "";
          return `
        <tr>
          <td>
            <strong>${pair}</strong>
            <div class="text-muted small">${getPairName(pair)}</div>
          </td>
          <td><div class="fw-bold">${d.bid} / ${d.ask}</div></td>
          <td><span class="${changeClass}">${changeSymbol}${
            d.changePercent
          }%</span></td>
          <td><div class="small">${d.high} / ${d.low}</div></td>
          <td><span class="badge bg-secondary">${d.spread}</span></td>
          <td><button class="btn btn-sm btn-outline-accent" onclick="tradePair('${pair}')"><i class="fas fa-chart-line me-1"></i>Trade</button></td>
        </tr>`;
        })
        .join("");
    }

    // -------------------- Helper functions for table generation --------------------
    function generateProfessionalTableData() {
      const pairs = [
        "EURUSD",
        "GBPUSD",
        "USDJPY",
        "USDCHF",
        "AUDUSD",
        "USDCAD",
        "NZDUSD",
        "EURGBP",
      ];
      const data = {};
      pairs.forEach((pair) => {
        const price =
          parseFloat(getInitialPrice(pair)) ||
          (1 + Math.random() * 0.1).toFixed(5);
        const change = (Math.random() * 0.3 - 0.15).toFixed(2);
        const changePercent = Math.abs(Number(change)).toFixed(2);
        data[pair] = {
          bid: price,
          ask: (parseFloat(price) * 1.00012).toFixed(5),
          change: Number(change),
          changePercent,
          high: (parseFloat(price) * 1.001).toFixed(5),
          low: (parseFloat(price) * 0.999).toFixed(5),
          spread: getProfessionalSpread(pair),
        };
      });
      return data;
    }

    function getPairName(pair) {
      const map = {
        EURUSD: "Euro / US Dollar",
        GBPUSD: "British Pound / US Dollar",
        USDJPY: "US Dollar / Japanese Yen",
        USDCHF: "US Dollar / Swiss Franc",
        AUDUSD: "Australian Dollar / US Dollar",
        USDCAD: "US Dollar / Canadian Dollar",
        NZDUSD: "New Zealand Dollar / US Dollar",
        EURGBP: "Euro / British Pound",
      };
      return map[pair] || pair;
    }

    function getProfessionalSpread(pair) {
      const spreads = {
        EURUSD: "0.6 pips",
        GBPUSD: "0.8 pips",
        USDJPY: "0.7 pips",
        USDCHF: "1.0 pips",
        AUDUSD: "0.9 pips",
        USDCAD: "1.1 pips",
        NZDUSD: "1.2 pips",
        EURGBP: "0.8 pips",
      };
      return spreads[pair] || "1.0 pips";
    }

    // initial fallback price map used by getInitialPrice()
    function getInitialPrice(pair) {
      const map = {
        EURUSD: "1.08742",
        GBPUSD: "1.27185",
        USDJPY: "148.234",
        USDCHF: "0.87956",
        AUDUSD: "0.65891",
      };
      return map[pair] || "1.00000";
    }

    // -------------------- tradePair (global function used by buttons) --------------------
    window.tradePair = function (pair) {
      window.location.href = `/trade?symbol=${encodeURIComponent(pair)}`;
    };

    // -------------------- Socket.io (optional) --------------------
    function setupSocket() {
      if (typeof io === "undefined") {
        // socket.io not present — skip
        return null;
      }

      try {
        const socket = io();

        socket.on("connect_error", (err) => {
          console.warn("Socket connect error:", err);
        });

        socket.on("forexUpdate", (data) => {
          // expected data format: { pairs: { EURUSD: { bid: "1.09", ask: "1.09", ... }, ... }, ts: timestamp }
          if (data && data.pairs) {
            // update forex widget and table
            updateLiveForexWidget(data.pairs);
            updateForexTable(data.pairs);
            if (lastUpdateEl && data.ts) {
              lastUpdateEl.textContent = new Date(data.ts).toLocaleTimeString();
            }
          }
        });

        return socket;
      } catch (err) {
        console.error("Socket setup failed:", err);
        return null;
      }
    }

    // -------------------- TICKER orchestration --------------------
    async function updateTickerOnce() {
      // fetch in parallel, but tolerate errors
      const [forexList, cryptoList, stocksList] = await Promise.allSettled([
        fetchForexForTicker(),
        fetchCryptoForTicker(),
        fetchStocksForTicker(),
      ]);

      const parts = [];

      if (forexList.status === "fulfilled")
        parts.push(...(forexList.value || []));
      if (cryptoList.status === "fulfilled")
        parts.push(...(cryptoList.value || []));
      if (stocksList.status === "fulfilled")
        parts.push(...(stocksList.value || []));

      // if nothing returned, show a short fallback
      if (parts.length === 0) {
        parts.push("Market data unavailable");
      }

      // join and set html
      setTickerHtml(parts.join(" &nbsp; | &nbsp; "));

      // update speed
      adjustTickerSpeed();
    }

    // -------------------- Kick off initial UI --------------------
    // populate forex widget and table with initial data
    updateLiveForexWidget(); // built from getInitialPrice fallback
    updateForexTable();

    // set up socket if available
    setupSocket();

    // initial ticker update and periodic refresh
    await updateTickerOnce();
    const tickerInterval = setInterval(updateTickerOnce, 30000); // 30s

    // Responsive adjustments
    window.addEventListener("resize", adjustTickerSpeed);

    // keep ticker speed accurate after fonts load (icon/font widths)
    window.addEventListener("load", () => {
      // small delay to ensure rendering done
      setTimeout(adjustTickerSpeed, 300);
    });

    // Defensive cleanup hook (if SPA navigation later)
    // return an object that could be used to stop intervals if needed
    return {
      stop: () => {
        clearInterval(tickerInterval);
      },
    };
  })();
</script>
